# üöÄ Blazingly fast üöÄ: Write-up

–í –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –≤–∏–¥–∏–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É `playground.rs`. –ï–≥–æ –º–æ–∂–Ω–æ —Å–ø–æ–∫–æ–π–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –≤—ã–≤–µ—Å—Ç–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä —Ç–∞–∫:

```rust
use std::fs;

fn run(flag: &UnsafeCell<String>) {
    println!("{}", fs::read_to_string("playground.rs").unwrap());
}
```

–†–µ–∑—É–ª—å—Ç–∞—Ç:

```rust
#![forbid(unsafe_code)]
use std::cell::UnsafeCell;

fn main() {
    let flag = std::fs::read_to_string("flag").unwrap();
    std::fs::File::create("flag").unwrap();
    run(&UnsafeCell::new(flag));
}
use std::fs;

fn run(flag: &UnsafeCell<String>) {
    println!("{}", fs::read_to_string("playground.rs").unwrap());
}
```

–ü–æ-–≤–∏–¥–∏–º–æ–º—É, –∫ –∑–∞—Å—ã–ª–∞–µ–º–æ–º—É —Ñ–∞–π–ª—É –ø—Ä–∏–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–∞–º–±—É–ª–∞, —Å—á–∏—Ç—ã–≤–∞—é—â–∞—è —Ñ–ª–∞–≥ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é, –∑–∞—Ç–∏—Ä–∞—é—â–∞—è –µ–≥–æ –ø—É—Å—Ç—ã–º —Ñ–∞–π–ª–æ–º –∏ –ø–µ—Ä–µ–¥–∞—é—â–∞—è –≤ —Ñ—É–Ω–∫—Ü–∏—é `run`. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ [`UnsafeCell`](https://doc.rust-lang.org/std/cell/struct.UnsafeCell.html) –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –¥–æ—Å—Ç–∞—Ç—å –∏–∑ —ç—Ç–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –±–µ–∑ `unsafe` –Ω–∏–∫–∞–∫ –Ω–µ–ª—å–∑—è. –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî `#![forbid(unsafe_code)]` ‚Äî –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `unsafe`, —Ç–∞–∫ —á—Ç–æ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç. –ë–æ–ª–µ–µ —Ç–æ–≥–æ, Rust –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞—Ä–∞–µ—Ç—Å—è –±—ã—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º —è–∑—ã–∫–æ–º, –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —ç—Ç–æ–≥–æ –∞—Ç—Ç—Ä–∏–±—É—Ç–∞ –∑–∞–ø—Ä–µ—â–∞–µ—Ç –≤ —Ç–æ–º —á–∏—Å–ª–µ –æ–ø—Ü–∏–∏, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ –ª–∏–Ω–∫–æ–≤–∫—É, —Ç–∞–∫ —á—Ç–æ –¥–æ–±–∏—Ç—å—Å—è —Ç–æ–≥–æ, —á—Ç–æ –Ω–∞—à –∫–æ–¥ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –ø–µ—Ä–µ–¥ `main`, –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ. –ù–∏–∫–∞–∫–∏—Ö –∫—Ä–µ–π—Ç–æ–≤, –∫—Ä–æ–º–µ `std`, –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ –Ω–µ—Ç, —Ç–∞–∫ —á—Ç–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —á—É–∂–æ–π –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–µ–π —Ç–æ–∂–µ –Ω–µ –ø–æ–ª—É—á–∏—Ç—Å—è.

–ü—Ä–∏–¥–µ—Ç—Å—è –æ–±—Ö–æ–¥–∏—Ç—å –≥–∞—Ä–∞–Ω—Ç–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —è–∑—ã–∫–∞. –ï—Å—Ç—å —Å–ª–æ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫–æ–π-–Ω–∏–±—É–¥—å –º–∏—Å–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞. –≠—Ç–æ, –≤–µ—Ä–æ—è—Ç–Ω–æ, –≤–æ–∑–º–æ–∂–Ω–æ, –Ω–æ –º—ã —ç—Ç–æ—Ç –≤–∞—Ä–∏–∞–Ω—Ç –æ–±–æ–π–¥–µ–º –≤ —Å–∏–ª—É –Ω–∞–ª–∏—á–∏—è –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è. –í–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è —Ç–µ–º, —á—Ç–æ Rust –Ω–µ –º–æ–∂–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω–µ –µ–≥–æ –æ–±–ª–∞—Å—Ç–∏ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏.

–ù–∞–ø—Ä–∏–º–µ—Ä, –º—ã –º–æ–∂–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å —Å –ø—Ä–æ–≥—Ä–∞–º–º–æ–π –Ω–∞ Python –∏ –∏–∑ –Ω–µ–µ —Å–¥–µ–ª–∞—Ç—å –ª—é–±—ã–µ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å Rust-–ø—Ä–æ—Ü–µ—Å—Å–æ–º. –ö–∞–∫ –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –ø–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞? –ù–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `ptrace` API –∏–ª–∏, —á—Ç–æ –µ—â–µ –ø—Ä–æ—â–µ, `/proc/pid/mem`. –°–æ–±—Å—Ç–≤–µ–Ω–Ω–æ, —ç—Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –º–æ–∂–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏ –∏–∑ —Å–∞–º–æ–≥–æ Rust, —á—Ç–æ –º—ã –∏ —Å–¥–µ–ª–∞–µ–º:

```rust
use std::fs;
use std::os::unix::fs::FileExt;

fn run(flag: &UnsafeCell<String>) {
    let mem = fs::File::open("/proc/self/mem").unwrap();
    let mut buf = [0; 100];
    mem.read_at(&mut buf, flag.get() as u64).unwrap();
    println!("{buf:?}");
}
```

```
[41, 0, 0, 0, 0, 0, 0, 0, 160, 139, 30, 243, 95, 85, 0, 0, 41, 0, 0, 0, 0, 0, 0, 0, 41, 0, 0, 0, 0, 0, 0, 0, 160, 139, 30, 243, 95, 85, 0, 0, 41, 0, 0, 0, 0, 0, 0, 0, 48, 0, 0, 0, 0, 0, 0, 0, 212, 46, 190, 242, 95, 85, 0, 0, 5, 0, 0, 0, 0, 0, 0, 0, 3, 179, 188, 242, 95, 85, 0, 0, 128, 71, 210, 63, 188, 127, 0, 0, 230, 168, 188, 242, 95, 85, 0, 0, 128, 71, 210, 63]
```

–≠—Ç–æ —è–≤–Ω–æ –Ω–µ ASCII. –ß—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫?

–ú—ã –≤—ã–≤–µ–ª–∏ –±–∞–π—Ç—ã –æ–±—ä–µ–∫—Ç–∞ —Ç–∏–ø–∞ [`String`](https://doc.rust-lang.org/std/string/struct.String.html). –†–∞–∑–¥–µ–ª –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ [Representation](https://doc.rust-lang.org/std/string/struct.String.html#representation) –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ —Ç–∞–∫–æ–π –æ–±—ä–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å, –¥–ª–∏–Ω—É —Å—Ç—Ä–æ–∫–∏ –∏ —Ä–∞–∑–º–µ—Ä –±—É—Ñ—Ñ–µ—Ä–∞ ‚Äî –ø—Ä—è–º–æ –∫–∞–∫ `std::string` –≤ C++. –ü–æ-–≤–∏–¥–∏–º–æ–º—É, –ø–µ—Ä–≤—ã–µ 8 –±–∞–π—Ç ‚Äî —Ç–æ –ª–∏ –¥–ª–∏–Ω–∞, —Ç–æ –ª–∏ —Ä–∞–∑–º–µ—Ä –±—É—Ñ—Ñ–µ—Ä–∞, –ø–æ—Ç–æ–º –∏–¥–µ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—å, –ø–æ—Ç–æ–º –æ–ø—è—Ç—å —Ç–æ –∂–µ —Å–∞–º–æ–µ —á–∏—Å–ª–æ. –í–æ—Å–ø–æ–ª—å–∑—É–µ–º—Å—è —ç—Ç–∏–º –∏ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–º —Ä–∞–∑—ã–º–µ–Ω–æ–≤–∞–Ω–∏–µ –µ—â–µ —Ä–∞–∑:

```rust
use std::fs;
use std::os::unix::fs::FileExt;

fn read_usize<T>(mem: &fs::File, address: *const T) -> usize {
    let mut buf = [0; 8];
    mem.read_at(&mut buf, address as usize as u64).unwrap();
    usize::from_ne_bytes(buf)
}

fn run(flag: &UnsafeCell<String>) {
    let mem = fs::File::open("/proc/self/mem").unwrap();
    let base = read_usize(&mem, (flag.get() as *const u8).wrapping_add(8));
    let length = read_usize(&mem, flag.get());
    let mut flag = vec![0; length];
    mem.read_at(&mut flag, base as u64).unwrap();
    let flag = String::from_utf8(flag).unwrap();
    println!("{flag}");
}
```

–û—Ç–º–µ—Ç–∏–º, —á—Ç–æ –ø–æ—Ä—è–¥–æ–∫ –ø–æ–ª–µ–π `Vec` –Ω–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø–æ—ç—Ç–æ–º—É –≤ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö –æ–Ω –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ –ø–æ–ø—Ä–∞–≤–∏—Ç—å –æ—Ñ—Ñ—Å–µ—Ç—ã.

–ù–∞–∫–æ–Ω–µ—Ü, –µ—Å–ª–∏ –≤—ã –ø–ª–æ—Ö–æ –∑–Ω–∞–µ—Ç–µ Rust –∏ –Ω–µ —Å–º–æ–≥–ª–∏ –≤—ä–µ—Ö–∞—Ç—å, –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É –Ω–∞ C –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–¥–ø—Ä–æ—Ü–µ—Å—Å, –ª–∏–±–æ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è Python –∏–ª–∏ shell.

–§–ª–∞–≥: **ugra_I_unsound_is_nauseating_2p7otpru7t3l**


# Postmortem

–î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–∑–¥–Ω–æ –≤ —Ö–æ–¥–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è –æ–±–Ω–∞—Ä—É–∂–∏–ª–æ—Å—å, —á—Ç–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ñ–∞–∫—Ç–æ–≤ –ø–æ—Ä–æ–∂–¥–∞–µ—Ç –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–¥–æ—Ä–∞–∑—É–º–µ–Ω–∏–µ:

1. –§–ª–∞–≥ –∫–ª–∞–¥–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–∫ volume –ø—Ä–∏ –µ–≥–æ —Å—Ç–∞—Ä—Ç–µ
2. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ `rustc playground.rs` –∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª –ø–æ–¥—Ä—è–¥
3. –ü—Ä–µ–∞–º–±—É–ª–∞ —É–¥–∞–ª—è–µ—Ç —Ñ–ª–∞–≥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ, –∞ –¥–æ —ç—Ç–æ–≥–æ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
4. `include_str!`

–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –±—ã–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è:

```rust
fn run(_flag: &UnsafeCell<String>) {
    println!("{}", include_str!("flag"));
}
```

–ü–æ-—Ö–æ—Ä–æ—à–µ–º—É –Ω—É–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª `flag` —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏. –ë—É–¥–µ–º –∑–Ω–∞—Ç—å.
